<html>
	<head>
		<title>Sync Hub</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="/Stylesheets/style.css">

		<script src="/js/bootstrap.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="/angular.js"></script>
		<script>

		</script>
	</head>
	<body>
		<nav class="navbar navbar-dark bg-primary navbar-expand-sm">
			<a class="navbar-brand" href="">
				<img src="/Resources/github-logo.png" width="30" height="30" class="d-inline-block align-top">
				SyncHub
			</a>
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" href="#">File</a>
				</li>
				<li class="nav-item">
						<a class="nav-link" href="#">Edit</a>
				</li>
				<li class="nav-item">
						<a class="nav-link" href="#">Preferences</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Terminal</a>
				</li>
			</ul>
		</nav>
		
		<div id="user-status" ng-app="user-status" ng-controller="user-status-controller">
			<ul class="list-group">
				<li class="list-group-item" ng-repeat="user in users">
					{{user}}
				</li>
			</ul>
		</div>
		
	
		<div id="text-editor">
			
			<div id="1" onmouseup = "mouse_click(event)" onkeydown="keydown_pressed(event)" contenteditable="true" class="line"><span class = "word" id="w1"></span></div>
			
		</div>

		<script src='/scripts/textbox_controller.js'></script>
		<script>
			var socket = io();
			var room_id = window.location.pathname; 
			
			/**
			Create line class 
			It contains line - object holding the line div tag
			Current word index - current word for this line
			*/
			class Line{

				constructor(line,current_word_index){
					this.line = line;
					this.current_word_index = current_word_index;
				}

			}
			
			var text_editor = document.getElementById("text-editor");
			var currentLine = 1;
			var lines = [];

			var pos = 1;
		   
			lines.push(new Line(document.getElementById("1"),1));

			
			function setCursorToEnd(ele){
				var range = document.createRange();
				var sel = window.getSelection();
				range.setStart(ele, 1);
				range.collapse(true);
				sel.removeAllRanges();
				sel.addRange(range);
				ele.focus();
			}
			
			function keydown_pressed(e){
				console.log(e.keyCode);

				

				if(e.keyCode == 13){
					pos = 1;
					var line = document.createElement("DIV");
					currentLine++;
					//console.log(currentLine);
					line.addEventListener("keydown",keydown_pressed);
					//line.addEventListener("mousedown",mouse_click);
					line.setAttribute("class","line");
					line.setAttribute("onmouseup","mouse_click(event)");
				
					line.setAttribute("contenteditable","true");
					line.id=(currentLine.toString());
					
					var word = document.createElement("SPAN");
					word.setAttribute("id","w1");
					word.setAttribute("class","word");
					line.appendChild(word);
					
					if(lines[currentLine-1] != null){
						//console.log(lines[currentLine-1].textContent);
						text_editor.insertBefore(line,text_editor.childNodes[currentLine+1]);
						lines.splice(currentLine-1,0,new Line(line,1));
					}
					else{
						text_editor.appendChild(line);
						lines.push(new Line(line,1));
					}
					pos = 1;
					line.focus();
					
					
				}
				else if(e.keyCode == 8){
					
					var line = lines[currentLine-1].line;
			
					if(line.textContent == "" && currentLine != 1){

						currentLine--;
						lines[currentLine-1].line.focus();
						line.remove();
						lines.splice(currentLine,1);
						
						setCursorToEnd(lines[currentLine-1].line);
						//console.log("hey");
						decrementAllLines(lines,currentLine);
						
						e.preventDefault();
					}

					//console.log("text content: "+line.getElementsByClassName("word")[lines[currentLine-1].current_word_index-1].textContent.trim());
					
					if(line.getElementsByClassName("word")[lines[currentLine-1].current_word_index-1].textContent.trim() === ""){
						
						decrementAllWords(lines[currentLine-1].current_word_index,line.getElementsByClassName("word"));
						lines[currentLine-1].current_word_index--;
					}

				}
				else if(e.keyCode == 32){

					pos = 1;

					var line = lines[currentLine-1];
					
					lines[currentLine-1].current_word_index++;

					var word = document.createElement("SPAN");

					word.setAttribute("id","w"+(line.current_word_index).toString());
					word.setAttribute("class","word");
					word.innerHTML = "&nbsp;";
					line.line.appendChild(word);
					
					//console.log("set location");
					setToCurrentLocation(line.line.getElementsByClassName("word")[lines[currentLine-1].current_word_index-1].childNodes[0], pos);
					pos++;
					e.preventDefault();
					
				}
				else{
					
					var line = lines[currentLine-1].line;
					var word = lines[currentLine-1].current_word_index-1;
					
					var letter;

					if(e.shiftKey){
						letter = String.fromCharCode(e.keyCode);
					}
					else{
						letter = String.fromCharCode(e.keyCode).toLowerCase();
					}

					console.log("current line: "+currentLine);

					if(line.getElementsByClassName("word")[word].textContent == null){
						line.getElementsByClassName("word")[word].textContent = letter;
						pos = 1;
					
					}
					else if(line.getElementsByClassName("word")[word].textContent.trim() === ""){
						lines[currentLine-1].current_word_index++;
						var wordSpan = document.createElement("SPAN");
						word++;
						pos = 1;
						wordSpan.setAttribute("id","w"+(lines[currentLine-1].current_word_index).toString());
						wordSpan.setAttribute("class","word");
						wordSpan.textContent = letter;
						line.appendChild(wordSpan);
					}
					else{
						var text = line.getElementsByClassName("word")[word].textContent;
						line.getElementsByClassName("word")[word].textContent = text.substring(0,pos-1) + letter +text.substring(pos-1,text.length);
					
					}
					
					setToCurrentLocation(line.getElementsByClassName("word")[word].childNodes[0], pos);
					pos++;

					//setEndOfContenteditable(line.getElementsByClassName("word")[word]);

					e.preventDefault();
				}
				
			}
		
			

			function decrementAllWords(start,word_list){
				
				for(var i = start; i <word_list.length; i++){
					word_list[i].id = "w"+(word_list[i].id.substring(1,word_list[i].id.length)-1);
				}

			}

			function decrementAllLines(lines_array, start){
				for(var i = start; i < lines_array.length; i++){
				
					lines_array[i].line.id = lines_array[i].line.id - 1;
				
				}
			}

			function setToCurrentLocation(element, pos){
				var range = document.createRange();
				range.setStart(element,pos);
				range.setEnd(element,pos);
				window.getSelection().removeAllRanges();
				window.getSelection().addRange(range);
			}
			
			function mouse_click(e){
				
				if(e.target.attributes.class.value.localeCompare("word") == 0){
					
					currentLine=parseInt(e.target.parentElement.id);
					
					pos = window.getSelection().anchorOffset+1;
					lines[currentLine-1].current_word_index = parseInt(e.target.id.substring(1,e.target.id.length));
					console.log("Current word index: "+e.target.id);
					console.log("pos: "+pos);
					console.log("windowanchornode: "+window.getSelection().focusNode.nodeValue);
					console.log(e.target);

				}
				else{
					currentLine=parseInt(e.target.id);
					lines[currentLine-1].current_word_index = lines[currentLine-1].line.getElementsByClassName("word").length;
					console.log(lines[currentLine-1].line.getElementsByClassName("word").length);
					pos = window.getSelection().anchorOffset+1;
					console.log(pos);
				}
				
				

			}

			function clearSelection() {
				if (window.getSelection) {
					if (window.getSelection().empty) { 
						window.getSelection().empty();
					} else if (window.getSelection().removeAllRanges) {
						window.getSelection().removeAllRanges();
					}
				} else if (document.selection) { 
					document.selection.empty();
				}
			}
			
			function findCurrentIndex(word){

				var elements = lines[currentLine-1].line.getElementsByClassName("word");

				for(var i = 0; i < elements.length; i++){
					if(word == elements[i].childNodes[0]){
						return i;
					}
				}
				return 0;
			}
		  
			resize = function(element) {
				element.style.height = 'auto';
				element.style.height = element.scrollHeight + 'px';
			}
			
			// change needed
			update_text = function(element) {
				console.log("updating text: "+room_id);
				socket.emit('text update', room_id, element.value, someInput.selectionStart);
				socket.emit('caret update', room_id, someInput.selectionStart);
				resize(element);
			}
	
			poupulate_text_box = function(element, text, pos) {
				if (element == document.activeElement) {
					var position = element.selectionStart;
					var last_len = element.value.length;
	
					element.value = text ;
					
					var next_len = element.value.length;
	
					element.selectionStart = element.selectionEnd = pos > position ? position : position + (next_len - last_len);
				} else {
					element.value = text
				}
				resize(element);
			}
	
			socket.on('text update', function(text, pos) {
				var textarea = document.getElementById('temp');
				console.log("updating");
				poupulate_text_box(textarea, text, pos)

				if (pos != - 1)
					socket.emit('caret update', room_id, textarea.selectionStart);
			});
			
			// WIP
			socket.on('load_file', function(content) {
				for (var i = 0; i < content.length; i ++) {
					var element = document.getElementById(content[i].element_id);
					var text    = content[i].text
				}
			});
	
			create_caret = function(id) {
				var caret = document.createElement('div');
				caret.id = id;
				caret.style.position = 'absolute';
				caret.style.height = '18px';
				caret.style.width = '1px';
				caret.style.backgroundColor = 'red';
				document.body.append(caret)
			}
	
			socket.on('join_room', function(users) {
				var scope = angular.element(document.getElementById('user-status')).scope();
				scope.$apply(function() {
					scope.users = [];
					for (var i = 0; i < users.length; i ++) {
						scope.users.push(users[i]);
					}
				});
	
				for (var i = 0; i < users.length; i ++) {
					var caret = document.getElementById(users[i]);
					if (!caret) {
						create_caret(users[i])
					}
				}
			});

			var someInput = document.getElementById("temp"),
				phantom = document.getElementById("phantom")

			socket.on('caret update', function(start, id) {
				refresh_content(someInput.value);

				var copy_style = getComputedStyle(temp)
				for (const property of copy_style)
				{
					phantom.style[property] = copy_style[property];
				}

				var coords = someInput.getCurrentCoordinates(start);
				phantom.style.display = 'none';

				var caret = document.getElementById(id);
				caret.style.top = coords.top;
				caret.style.left = coords.left;
			});
	
			someInput.getCurrentCoordinates = function(start){
				var index = start,
					inputRect = this.getBoundingClientRect();
					charRect = phantom.children[index].getBoundingClientRect();
				return {
					top:charRect.top,
					left:charRect.left,
					relTop:charRect.top - inputRect.top,
					relLeft:charRect.left - inputRect.left,
					width:charRect.width
				};
			};
	
			someInput.addEventListener("keyup",function(e){
				socket.emit('caret update', room_id, this.selectionStart);
			});

			someInput.addEventListener("keydown", function(e){
				socket.emit('caret update', room_id, this.selectionStart);
			});

			someInput.addEventListener('click', function(e) {
				socket.emit('caret update', room_id, this.selectionStart);
			});

			function remove_children(node){
				while(node.hasChildNodes()){
					node.removeChild(node.lastChild);
				}
			}

			function refresh_content(text){
				remove_children(phantom);
				
				var span = document.createElement('span');
				for (const character of (text + '.').split("")) {
					span.textContent = character;
					phantom.appendChild(span.cloneNode(true))
				}
				span.remove();
			}

			socket.emit("join room", room_id);
		</script>
	</body>
</html>